<!DOCTYPE html>
<html lang="pt-br">

    <!-- Al√≠cia -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Meeple</title>
    <link rel="stylesheet" href="CSS/padrao.css">
    <link rel="stylesheet" href="CSS/perfil.css">
</head>
<body>
    <header>
        <nav>
        <div>
            <img id="logoSite" src="midia/logoStarMeeple.png" alt="StarMeeple">
            <input type="text" placeholder="O que voc√™ est√° procurando?">
            <button>üîç</button>
            <button>üí¨</button>
            <img id="logoUsuario" src="avatar.png" alt="Avatar do usu√°rio">
            <span>3</span>
        </div>
        <ul>
        <li id="linkJogosCartas">Jogos de Cartas</li>
        <li id="linkJogosTabuleiro">Jogos de tabuleiro</li>
        <li id="linkQuebraCabecas">Quebra-cabe√ßas</li>
        <li id="linkFamilia">Familia</li>
        <li id="linkRPG">RPG</li>
        <li id="link18">+18</li>
        </ul>
        </nav>
    </header>

    <main>
        <div class="perfil">
            <h2 id="nomeUsuario">Carregando...</h2>
            <button onclick="mostrarPopup()">Deletar Conta</button>
            <div class="infoUser">
                <img src="default-profile.jpg" alt="Foto de perfil do usu√°rio" id="fotoPerfil">
                <p id="nomeCompleto">Carregando...</p>
                <p id="idadeUsuario">Carregando...</p>
                <p id="cpfUsuario">Carregando...</p>
                <p id="enderecoUsuario">Carregando...</p>
                <p id="cepUsuario">CEP: N√£o informado</p> 
                <p id="telefoneUsuario">Carregando...</p>
                <p id="emailUsuario">Carregando...</p>
            </div>
            <button>Fale Conosco</button>
            <button onclick="mostrarPopupSeguranca()">Seguran√ßa</button>
        </div>
        <div class="pedidos">
            <h2>Acompanhe seus pedidos</h2>
            <div class="pedido">
                <h3>Pedido: #fef8vrf65vc</h3>
                <div class="infoPedido">
                    <h3>Status do pedido: Status</h3>
                    <div class="infoProduto01">
                        <p>Item #vf8rgs5csdgr5</p>
                        <img src="" alt="Foto do produto">
                        <p>Produto: Jogo01</p>
                        <p>QTD: 1</p>
                        <p>Valor: R$ 45,13</p>
                        <button>Avaliar/Comentar</button>
                    </div>
                    <div class="infoProduto02">
                        <p>Item #vf8rgs5csdgr5</p>
                        <img src="" alt="Foto do produto">
                        <p>Produto: Jogo01</p>
                        <p>QTD: 1</p>
                        <p>Valor: R$ 45,13</p>
                        <button>Avaliar/Comentar</button>
                    </div>
                    <h3>Valor total do pedido: R$ 124,00</h3>
                    <h3>Data do pedido: 04/04/2025</h3>
                    <button>Problemas com pedido</button>
                </div>
            </div>
            <div class="pedido">
                <h3>Pedido: #fef8vrf65vc</h3>
                <div class="infoPedido">
                    <h3>Status do pedido: Status</h3>
                    <div class="infoProduto01">
                        <p>Item #vf8rgs5csdgr5</p>
                        <img src="" alt="Foto do produto">
                        <p>Produto: Jogo01</p>
                        <p>QTD: 1</p>
                        <p>Valor: R$ 45,13</p>
                        <button>Avaliar/Comentar</button>
                    </div>
                    <div class="infoProduto02">
                        <p>Item #vf8rgs5csdgr5</p>
                        <img src="" alt="Foto do produto">
                        <p>Produto: Jogo01</p>
                        <p>QTD: 1</p>
                        <p>Valor: R$ 45,13</p>
                        <button>Avaliar/Comentar</button>
                    </div>
                    <h3>Valor total do pedido: R$ 124,00</h3>
                    <h3>Data do pedido: 04/04/2025</h3>
                    <button>Problemas com pedido</button>
                </div>
            </div>
        </div>

        <div class="popupConta" id="popupConta" class="popupConta">
            <div class="popup-content">
                <h3>Voc√™ tem certeza que deseja apagar sua conta?</h3>
                <p>Todos os seus dados ser√£o apagados depois de 30 dias.</p>
                <button class="close" onclick="esconderPopup()">Cancelar</button>
                <button>Apagar</button>
            </div>
        </div>

        <div class="popupSeguranca" id="popupSeguranca" class="popupSeguranca">
            <div class="popup-content">
                <p>Deseja reportar um problema de seguran√ßa, como vazamento de senhas, dados sens√≠veis, entre outros, etc...?</p>
                <button class="close" onclick="esconderPopupSeguranca()">Cancelar</button>
                <button>Reportar</button>
            </div>
        </div>
    </main>

    <footer>
        <div class="formPagamento">
            <p>Formas de Pagamento</p>
            <div class="imgsPagamento">
              <img src="visa.png" alt="Visa">
              <img src="mastercard.png" alt="Mastercard">
              <img src="elo.png" alt="Elo">
            </div>  
        </div>
  
        <div class="logoStar">
            <img src="logo.png" alt="StarMeeple logo">
            <p>StarMeeple 2025</p>
        </div>
  
        <div class="linkSocial">
            <p>Nos sigam nas redes sociais:</p>
            <a href="https://www.instagram.com">Instagram</a>
            <a href="https://www.facebook.com">Facebook</a>
        </div>
      </footer>

    <script>
        function mostrarPopup() {
          document.getElementById("popupConta").style.display = "block";
        }
        
        function esconderPopup() {
          document.getElementById("popupConta").style.display = "none";
        }

        function mostrarPopupSeguranca() {
          document.getElementById("popupSeguranca").style.display = "block";
        }
        
        function esconderPopupSeguranca() {
          document.getElementById("popupSeguranca").style.display = "none";
        }
    </script>
    <script src="/templates/JS/padrao.js"></script>

    <script>
            document.addEventListener('DOMContentLoaded', async function() {
    const token = localStorage.getItem('access_token');
    const userData = localStorage.getItem('user');
    
    // Verifica√ß√£o inicial de autentica√ß√£o
    if (!token || !userData) {
        redirectToLogin();
        return;
    }

    try {
        // Exibe dados b√°sicos do localStorage enquanto carrega
        displayTemporaryData(JSON.parse(userData));
        
        // Carrega dados atualizados da API
        await loadProfileData(token);
    } catch (error) {
        handleProfileError(error);
    }
});

// Fun√ß√£o para exibir dados tempor√°rios
function displayTemporaryData(user) {
    document.getElementById('nomeCompleto').textContent = `Nome completo: ${user.nome || 'Carregando...'}`;
    document.getElementById('emailUsuario').textContent = `Email: ${user.email || 'Carregando...'}`;
}

// Fun√ß√£o principal para carregar dados
async function loadProfileData(token) {
    try {
        const response = await fetch('http://127.0.0.1:8000/api/perfil/', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            const errorData = await parseErrorResponse(response);
            throw new Error(errorData.message || 'Erro ao carregar perfil');
        }

        const data = await response.json();
        updateProfileUI(data);
        
    } catch (error) {
        console.error('Erro detalhado:', error);
        throw error; // Re-lan√ßa para tratamento no catch principal
    }
}

// Atualiza a interface com os dados
function updateProfileUI(data) {
    document.getElementById('nomeCompleto').textContent = `Nome completo: ${data.nome || 'N√£o informado'}`;
    document.getElementById('idadeUsuario').textContent = `Idade: ${data.idade ? data.idade + ' anos' : 'N√£o informada'}`;
    document.getElementById('cpfUsuario').textContent = `CPF: ${formatCPF(data.cpf)}`;
    document.getElementById('enderecoUsuario').textContent = `Endere√ßo: ${data.endereco || 'N√£o informado'}`;
    document.getElementById('telefoneUsuario').textContent = `Telefone: ${formatPhone(data.telefone)}`;
    document.getElementById('emailUsuario').textContent = `Email: ${data.email || 'N√£o informado'}`;
}

// Fun√ß√µes auxiliares
function formatCPF(cpf) {
    if (!cpf) return 'N√£o informado';
    return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
}

function formatPhone(phone) {
    if (!phone) return 'N√£o informado';
    const nums = phone.replace(/\D/g, '');
    return nums.replace(/(\d{2})(\d{4,5})(\d{4})/, '($1) $2-$3');
}

async function parseErrorResponse(response) {
    try {
        return await response.json();
    } catch {
        return {
            status: response.status,
            message: response.statusText
        };
    }
}

function handleProfileError(error) {
    console.error('Erro no perfil:', error);
    
    // Mostra mensagem amig√°vel
    const errorContainer = document.createElement('div');
    errorContainer.className = 'error-message';
    errorContainer.innerHTML = `
        <p>N√£o foi poss√≠vel carregar os dados do perfil.</p>
        <p>${error.message}</p>
        <button onclick="window.location.reload()">Tentar novamente</button>
        <button onclick="redirectToLogin()">Fazer login novamente</button>
    `;
    
    document.querySelector('.infoUser').appendChild(errorContainer);
}

function redirectToLogin() {
    localStorage.removeItem('access_token');
    localStorage.removeItem('user');
    window.location.href = '/login/';
}
    </script>
</body>
</html>