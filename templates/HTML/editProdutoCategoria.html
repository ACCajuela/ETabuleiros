<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Finaliza√ß√£o do Pedido - StarMeeple</title>
  <link rel="stylesheet" href="CSS/padrao.css">
  <link rel="stylesheet" href="CSS/editProdutoCategoria.css">
</head>
<body>
  <header id="header">
    <nav>
      <div>
        <img id="logoSite" src="midia/logoStarMeeple.png" alt="StarMeeple">
        <input type="text" placeholder="O que voc√™ est√° procurando?" />
        <button>üîç</button>
        <button>üí¨</button>
        <img id="logoUsuario" src="avatar.png" alt="Avatar do usu√°rio">
        <span>3</span>
      </div>
      <ul>
        <li id="linkJogosCartas">Jogos de Cartas</li>
        <li id="linkJogosTabuleiro">Jogos de tabuleiro</li>
        <li id="linkQuebraCabecas">Quebra-cabe√ßas</li>
        <li id="linkFamilia">Fam√≠lia</li>
        <li id="linkRPG">RPG</li>
        <li id="link18">+18</li>
      </ul>
    </nav>
  </header>

  <main id="main">
    <h1>Edi√ß√£o de Produtos</h1>
    <div class="produtos">
      <button id="newProduto" onclick="mostrarPopupProduto()">+ Novo Produto</button>
      <div class="listaProdutos">
        <div class="infoProduto">
          <p>NomeProduto</p>
          <img src="" alt="Foto do Produto" />
          <button id="btnEdit" onclick="mostrarPopupProduto()">Editar</button>
          <button id="btnExcluir" onclick="mostrarPopupSeguranca()">Excluir</button>
        </div>
      </div>
    </div>

    <h1>Cupons e Promo√ß√µes</h1>
    <div class="cupons">
      <button id="newCupom" onclick="mostrarPopupCupom()">+ Novo Cupom</button>
      <div class="listaCupons">
        <div class="infoCupom">
          <p>nomeCupom</p>
          <div class="btns">
            <button id="btnEditCP" onclick="mostrarPopupProduto()">Editar</button>
            <button id="btnExcluirCP" onclick="mostrarPopupSeguranca()">Excluir</button>
          </div>
        </div>
      </div>
    </div>

    <div class="promocoes">
      <button id="newPromocao" onclick="mostrarPopupPromocao()">+ Nova Promo√ß√£o</button>
      <div class="listaPromocoes">
        <div class="infoPromocao">
          <p>nomePromocao</p>
          <div class="btns">
            <button id="btnEditCP" onclick="mostrarPopupProduto()">Editar</button>
            <button id="btnExcluirCP" onclick="mostrarPopupSeguranca()">Excluir</button>
          </div>
        </div>
      </div>
    </div>

    <div class="popupProduto" id="popupProduto">
      {% csrf_token %}
      <div class="popup-content">
        <h3>Novo Produto</h3>
        <p>Nome</p>
        <input type="text">
        <p>Categoria</p>
        <input type="text">
        <p>N¬∞ de jogadores</p>
        <input type="text">
        <p>Descri√ß√£o</p>
        <input type="text">
        <p>Quantidade em estoque</p>
        <input type="text">
        <p>Autor</p>
        <input type="text">
        <p>Editora</p>
        <input type="text">
        <p>Classifica√ß√£o Indicativa</p>
        <input type="text">
        <button onclick="cadastrarProduto()">Confirmar</button>
        <button class="close" onclick="esconderPopupProduto()">Cancelar</button>
      </div>
    </div>

    <div class="popupCupom" id="popupCupom">
      <div class="popup-content">
        <h3>Novo Cupom</h3>
        <p>Nome</p>
        <input type="text">
        <p>Situa√ß√£o</p>
        <input type="text">
        <p>M√©todo de desconto</p>
        <select name="metodoDesconto" id="metodoDesconto">
          <option value="percentual">Percentual</option>
          <option value="preco">Pre√ßo</option>
        </select>
        <p>Pre√ßo de desconto</p>
        <input type="text">
        <p>Data de valida√ß√£o</p>
        <input type="date">
        <input type="date">
        <button onclick="loginForm()">Confirmar</button>
        <button class="close" onclick="esconderPopupCupom()">Cancelar</button>
      </div>
    </div>

    <div class="popupPromocao" id="popupPromocao">
      <div class="popup-content">
        <h3>Nova Promo√ß√£o</h3>
        <p>Nome</p>
        <input type="text">
        <p>Descri√ß√£o</p>
        <input type="text">
        <p>Desconto (%)</p>
        <input type="number">
        <button onclick="mostrarPopupSeguranca()">Confirmar</button>
        <button class="close" onclick="esconderPopupPromocao()">Cancelar</button>
      </div>
    </div>
  </main>

  <footer id="footer">
      <div class="formPagamento">
        <p>Formas de Pagamento</p>
        <div class="imgsPagamento">
          <img src="midia/pix.png" alt="Pix" />
          <img src="midia/visa.png" alt="Visa" />
          <img src="midia/mastercard.png" alt="Mastercard" />
          <img src="midia/amex.png" alt="Elo" />
        </div>
      </div>

      <div class="logoStar">
        <img src="midia/logoStarMeeple.png" alt="StarMeeple logo" />
        <p>StarMeeple 2025</p>
      </div>

      <div class="linkSocial">
        <p>Nos sigam nas redes sociais:</p>
        <a href="https://www.instagram.com"
          ><img src="midia/instagram.jpg" alt="" />Instagram</a
        >
        <a href="https://www.facebook.com"
          ><img src="midia/facebook.png" alt="" />Facebook</a
        >
      </div>
    </footer>

  <script>

    // Fun√ß√£o para obter cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


    async function cadastrarProduto() {
    // Verifique se o CSRF token existe
    const csrftoken = getCookie('csrftoken');
    if (!csrftoken) {
        alert('Erro de seguran√ßa: Token CSRF n√£o encontrado!');
        return;
    }

    const inputs = document.querySelectorAll('.popupProduto input');
    const produtoData = {
        nome: inputs[0].value,
        categoria: inputs[1].value,
        num_jogadores: inputs[2].value,
        descricao: inputs[3].value,
        qtd_estoque: parseInt(inputs[4].value) || 0,
        autor: inputs[5].value,
        editora: inputs[6].value,
        classificacao_indicativa: inputs[7].value
    };

    try {
    const response = await fetch('http://localhost:5500/api/produtos/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(produtoData),
        credentials: 'include'
    });

    const contentType = response.headers.get("content-type");

    if (!response.ok) {
        if (contentType && contentType.includes("application/json")) {
            const error = await response.json();
            throw new Error(error.detail || JSON.stringify(error));
        } else {
            const errorText = await response.text(); // erro n√£o-JSON
            throw new Error(`Erro ${response.status}: ${errorText}`);
        }
    }

    if (contentType && contentType.includes("application/json")) {
        const data = await response.json();
        alert(`Produto "${data.nome}" cadastrado com sucesso!`);
    } else {
        alert("Produto cadastrado com sucesso (sem resposta JSON)");
    }

    esconderPopupProduto();
    inputs.forEach(input => input.value = '');
    
} catch (error) {
    console.error('Erro completo:', error);
    alert(`Erro ao cadastrar: ${error.message}`);
}

}
  </script>

  <script>
    function mostrarPopupProduto() {
      document.getElementById("popupProduto").style.display = "flex";
    }
    function esconderPopupProduto() {
      document.getElementById("popupProduto").style.display = "none";
    }
    function mostrarPopupCupom() {
      document.getElementById("popupCupom").style.display = "flex";
    }
    function esconderPopupCupom() {
      document.getElementById("popupCupom").style.display = "none";
    }
    function mostrarPopupPromocao() {
      document.getElementById("popupPromocao").style.display = "flex";
    }
    function esconderPopupPromocao() {
      document.getElementById("popupPromocao").style.display = "none";
    }
    function mostrarPopupCategoria() {
      document.getElementById("popupCategoria").style.display = "flex";
    }
    function esconderPopupCategoria() {
      document.getElementById("popupCategoria").style.display = "none";
    }
    function mostrarPopupSeguranca() {
      document.getElementById("popupSeguranca").style.display = "block";
    }
    function esconderPopupSeguranca() {
      document.getElementById("popupSeguranca").style.display = "none";
    }
  </script>

</body>
</html>
